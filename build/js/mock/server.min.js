!function(e,t){"use strict";var n,r,a={},o={},s={},u={};n={on:function(e,t){a[e]=a[e]||[],a[e].push(t)},once:function(e,t){s[e]=s[e]||[],s[e].push(t)},emit:function(e,t){var n=o[e],r=u[e],a=Array.prototype.slice.call(arguments,1);n&&(n.forEach(function(e){e.apply(null,a)}),r&&(r.forEach(function(e){e.apply(null,a)}),r=[]))}},r={on:function(e,t){o[e]=o[e]||[],o[e].push(t)},once:function(e,t){u[e]=u[e]||[],u[e].push(t)},emit:function(e,t){var n=a[e],r=s[e],o=Array.prototype.slice.call(arguments,1);n&&(n.forEach(function(e){e.apply(null,o)}),r&&(r.forEach(function(e){e.apply(null,o)}),r=[]))}},e.io={listen:function(){return n},connect:function(){return r}}}(this,utils),function(e,t,n){"use strict";var r=t.find,a=t.findIndex,o=t.remove,s=t.assign,u=t.on,i=2,c=1000000004,m={defaultAvatar:"../../img/default-avatar.png",defaultGroupAvatar:"../../img/group.png",defaultTeamAvatar:"../../img/team.png",users:[{account:"user1",nickName:"233",avatar:"../../img/notice.png",gender:"male",birthday:"1995-10-10",tel:"13007506620",email:"784623601@qq.com"},{account:"user2",nickName:"user2",gender:"male",avatar:"../../img/search-group.png",birthday:"2014-02-14"},{account:"shady1128",nickName:"shadow",gender:"female",avatar:null},{account:"shmily2004",nickName:"shmily",avatar:null},{account:"user3",nickName:"user3",avatar:null,sign:"test"},{account:"user4",nickName:"user4",avatar:null},{account:"user5",nickName:"username5",avatar:null},{account:"xt112233",nickName:"111",avatar:null}],friends:[{account:"user1",friends:[{account:"shady1128"},{account:"shmily2004",noteName:"???"},{account:"user2",noteName:"test"},{account:"user4"},{account:"user5"}]}],blacklists:[{account:"user1",blacklist:[{account:"user3",noteName:"?",friend:!0}]}],groups:[{account:1000000001,name:"user1、user2等人",owner:"user1",des:"",permissions:{verify:1,invite:0,modify:0,verifyed:0},members:["user1","user2","xt112233"]},{account:1000000002,name:"group",owner:"user1",des:"",permissions:{verify:1,invite:0,modify:0,verifyed:0},members:["user1","user3"]},{account:1000000003,name:"233、user2等人",owner:"user2",des:"",permissions:{verify:1,invite:0,modify:0,verifyed:0},members:["user2","user3"]},{account:1000000004,name:"233、user2等人",owner:"user2",des:"",permissions:{verify:1,invite:0,modify:0,verifyed:0},members:["user2","user1"]}],teams:[{account:1,name:"讨论组",owner:"user1",members:["user1","user2","user3"]},{account:2,name:"user1、user2、user3等人",owner:"user1",members:["user1","user2","user3"]}],messages:[{type:"p2p",from:"user2",to:"user1",unRead:1,updateTime:1491208689012,messages:[{content:"what are you doing",time:1491208489012},{content:"hello world!",time:1491208587512},{content:"????",time:1491208689012}]},{type:"p2p",from:"user1",to:"user2",unRead:0,updateTime:1491208589012,messages:[{content:"hay",time:1491208589012}]},{type:"group",from:"xt112233",to:1000000001,updateTime:1491208942511,messages:[{content:"hello world",time:1491208942511}]},{type:"group",from:"user1",to:1000000001,updateTime:1491208932167,messages:[{content:"你好",time:1491208932167}]}]},f=m,p={getInitData:function(e){var n=this;if("object"!=typeof f)return null;var r={defaultAvatar:f.defaultAvatar,defaultGroupAvatar:f.defaultGroupAvatar,defaultTeamAvatar:f.defaultTeamAvatar,friends:n.getFriendsInfoByUser(e),groups:n.getGroupsByUser(e),teams:n.getTeamsByUser(e),sessions:n.getSessionByUser(e),blacklist:n.getBlacklistByUser(e)||[],blacklistMembersInfo:n.getBlacklistMembersInfo(e)},a=this.getUser(e);return r.groupsMembersInfo=function(){var e={},t=r.groups,a=r.teams;return t.forEach(function(t){t.members.forEach(function(t){e[t]=n.getUser(t)})}),a.forEach(function(t){t.members.forEach(function(t){e[t]=n.getUser(t)})}),e}(),JSON.parse(JSON.stringify(t.assign(r,a)))},getUser:function(e){return r(f.users,function(t){return t.account==e})},getFriendsInfoByUser:function(e){var t=[],n=this;return this.getFriendsByUser(e).forEach(function(e){var r={},a=n.getUser(e.account);for(var o in a)"friends"!==o&&(r[o]=a[o]);r.noteName=e.noteName,t.push(r)}),t},getFriendsByUser:function(e){var t=r(f.friends,function(t){return t.account===e});if(t&&t.friends)return t.friends},getBlacklistByUser:function(e){var t=r(f.blacklists,function(t){return t.account===e});if(t&&t.blacklist)return t.blacklist},getGroupsByUser:function(e){var t=[];return f.groups.forEach(function(n){r(n.members,e)&&t.push(n)}),t},getTeamsByUser:function(e){var t=[];return f.teams.forEach(function(n){r(n.members,e)&&t.push(n)}),t},getSessionByUser:function(e){var t=[],n=this,r=n.getGroupsByUser(e);return f.messages.forEach(function(n){var o,s;if("p2p"===n.type)if(n.to===e)s=a(t,function(e){return e.account===n.from}),o=t[s]||{account:n.from},o.unRead=n.unRead;else{if(n.from!==e)return;s=a(t,function(e){return e.account===n.to}),o=t[s]||{account:n.to}}else{if(-1===a(r,function(e){return e.account===n.to}))return;s=a(t,function(e){return e.account===n.to}),o=t[s]||{account:n.to}}o.type=o.type||("number"!=typeof o.account?"p2p":o.account<1e9?"team":"group"),o.messages=o.messages||[],n.messages.forEach(function(e){o.messages.push({from:n.from,content:e.content,time:e.time,type:n.type})}),-1===s&&t.push(o)}),t.forEach(function(e){e.messages.sort(function(e,t){return e.time-t.time}),e.updateTime=e.messages[e.messages.length-1].time}),t.sort(function(e,t){return t.updateTime-e.updateTime}),t},getCloudMsg:function(e,t){var n={};return void 0!==t?(n.type="p2p",f.messages.forEach(function(r){(r.from===t&&r.to===e||r.to===t&&r.from===e)&&(n.account!==e&&(n.account=e,n.messages=[]),r.messages.forEach(function(e){var t={from:r.from,content:e.content,time:e.time,type:e.type||r.type};n.messages.push(t)}))})):(n.type="group",f.messages.forEach(function(t){t.to===e&&(n.account!==e&&(n.account=e,n.messages=[]),t.messages.forEach(function(e){n.messages.push({from:t.from,content:e.content,time:e.time,type:e.type||t.type})}))})),n.messages?(n.messages.sort(function(e,t){return e.time-t.time}),n):null},getMessage:function(e,t){return r(f.messages,function(n){return n.to===e&&n.from===t})||null},getGroup:function(e){return r(f.groups,function(t){return t.account===e})||null},getBlacklistMembersInfo:function(e){var t=[],n=this,r=this.getBlacklistByUser(e);return r&&r.forEach&&r.forEach(function(e){var r=n.getUser(e.account);t.push(r)}),t},getGroupPermission:function(e){return this.getGroup(e).permissions},getTeam:function(e){return r(f.teams,function(t){return t.account===e})||null},getTeamMembersInfo:function(e){var t=[],n=this;return this.getTeam(e).members.forEach(function(e){var r=n.getUser(e);t.push({account:r.account,avatar:r.avatar,nickName:r.nickName})}),t},searchUser:function(e){var t=this.getUser(e);return t?{success:!0,data:{account:t.account,nickName:t.nickName,avatar:t.avatar||data.defaultAvatar,relation:"no-friend"}}:{success:!1,msg:"该帐号不存在，请检查你输入的帐号是否正确"}},searchGroup:function(e){var t=this.getGroup(e),n="group";return t||(t=this.getTeam(e),n="team"),t?{success:!0,data:{account:t.account,groupName:t.name,avatar:t.avatar||"group"===n?f.defaultGroupAvatar:f.defaultTeamAvatar,relation:"no-friend"}}:{success:!1}},updateMessage:function(e){var t=this.getMessage(e.to,e.from);null!==t?(t.messages.push(e),t.updateTime=e.time):f.messages.push({type:e.type,from:e.from,to:e.to,unRead:0,updateTime:e.time,messages:[{content:e.content,time:e.time}]})},getFriendInfo:function(e,t){var n=this.getFriendsByUser(e);return r(n,function(e){return e.account===t})},isFriend:function(e,t){return void 0!==this.getFriendInfo(e,t)},addFriend:function(e,t,n){var r,a={account:t};n&&(a.noteName=n),(r=this.getFriendsByUser(e))?r.push(a):f.friends.push({account:e,friends:[a]}),(r=this.getFriendsByUser(t))?r.push({account:e}):f.friends.push({account:t,friends:[{account:e}]})},removeFriend:function(e,t,n){var a,s,u;(a=this.getFriendsByUser(e))&&o(a,function(e){return e.account===t}),(a=this.getFriendsByUser(t))&&o(a,function(t){return t.account===e}),void 0===n&&((s=this.getBlacklistByUser(e))&&(u=r(s,function(e){return e.account===t}))&&(u.friend=!1),(s=this.getBlacklistByUser(t))&&(u=r(s,function(t){return t.account===e}))&&(u.friend=!1))},addBlacklist:function(e,t,n){var r=this.getBlacklistByUser(e),a={account:t};if(n){var o=this.getFriendInfo(e,t);o.noteName&&(a.noteName=o.noteName),a.friend=!0}else a.friend=!1;return r?r.push(a):f.blacklists.push({account:e,blacklist:[a]}),a},removeBlacklist:function(e,t){var n=this.getBlacklistByUser(e);if(n)return o(n,function(e){return e.account===t})[0]},generateGroupName:function(e){return e.join("、").slice(0,10)+"等人"},createGroup:function(e,t){var n={account:++c,name:this.generateGroupName(t),owner:e,des:"",permissions:{verify:1,invite:0,modify:0,verifyed:0},members:t};return f.groups.push(n),n},createTeam:function(e,t){var n={account:++i,name:this.generateGroupName(t),owner:e,des:"",members:t};return f.teams.push(n),n},addGroupMember:function(e,t){var n=this.getGroup(e);if(null!==n)return n.members=n.members.concat(t),n},addTeamMember:function(e,t){var n=this.getTeam(e);if(null!==n)return n.members=n.members.concat(t),n},removeGroupMember:function(e,t){var n=this.getGroup(e);null!==n&&t.forEach(function(e){o(n.members,e)})},removeTeamMember:function(e,t){var n=this.getTeam(e);null!==n&&t.forEach(function(e){o(n.members,e)})},existGroup:function(e,t){var n=this.getGroup(e);null!==n&&o(n.members,t)},existTeam:function(e,t){var n=this.getTeam(e);null!==n&&(o(n.members,t),t===n.owner&&(n.owner=n.members[0]))},dissolveGroup:function(e){o(f.groups,function(t){return t.account===e})},updateNoteName:function(e,t,n){var a=r(f.friends,function(t){return t.account===e});if(a){r(a.friends,function(e){return e.account===t}).noteName=n}},updateUserInfo:function(e,t){var n=this.getUser(e);return s(n,t),n},updateGroupName:function(e,t){this.getGroup(e).name=t},updateGroupDes:function(e,t){this.getGroup(e).des=t},updateAuthentication:function(e,t){this.getGroup(e).permissions.verify=t},updateInvitePermissions:function(e,t){this.getGroup(e).permissions.invite=t},updateModifyPermissions:function(e,t){this.getGroup(e).permissions.modify=t},updateBeAuthentication:function(e,t){this.getGroup(e).permissions.verifyed=t},updateTeamName:function(e,t){this.getTeam(e).name=t}};!function(){var e=n.listen();e.on("getUserInfo",function(t){var n=p.getInitData(t.account);e.emit("init",n)}),e.on("getCloudMsg",function(t){var n=p.getCloudMsg(t.to,t.from);e.emit("refreshCloudMsg",n)}),e.on("othersInfo-getUser",function(t){var n=p.getUser(t.account);e.emit("refreshOthersInfo",n)}),e.on("searchUser",function(t){var n=p.searchUser(t.account);e.emit("searchUserResult",n)}),e.on("searchGroup",function(t){var n=p.searchGroup(t.account);e.emit("searchGroupResult",n)}),e.on("createGroup",function(t){var n=p.createGroup(t.owner,t.members);e.emit("addGroup",n);var r={};t.members.forEach(function(e){r[e]=p.getUser(e)}),e.emit("updateGroupsMembersInfo",r)}),e.on("createTeam",function(t){var n=p.createTeam(t.owner,t.members);e.emit("addTeam",n);var r={};t.members.forEach(function(e){r[e]=p.getUser(e)}),e.emit("updateGroupsMembersInfo",r)}),e.on("addGroupMember",function(t){p.addGroupMember(t.account,t.members),e.emit("addGroupMember",t);var n={};t.members.forEach(function(e){n[e]=p.getUser(e)}),e.emit("updateGroupsMembersInfo",n)}),e.on("addTeamMember",function(t){p.addTeamMember(t.account,t.members),e.emit("addTeamMember",t);var n={};t.members.forEach(function(e){n[e]=p.getUser(e)}),e.emit("updateGroupsMembersInfo",n)}),e.on("removeGroupMember",function(t){p.removeGroupMember(t.account,t.members),e.emit("removeGroupMember",t)}),e.on("removeTeamMember",function(t){p.removeTeamMember(t.account,t.members),e.emit("removeTeamMember",t)}),e.on("existGroup",function(t){p.existGroup(t.account,t.target),e.emit("removeGroup",t);var n={to:t.account,type:"systemMsg",content:"你退出了群",time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("existTeam",function(t){p.existTeam(t.account,t.target),e.emit("removeTeam",t);var n={to:t.account,type:"systemMsg",content:"你退出了讨论组",time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("dissolveGroup",function(t){p.dissolveGroup(t.account),e.emit("removeGroup",t);var n={to:t.account,type:"systemMsg",content:"你解散了群",time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("addFriend",function(t){p.addFriend(t.account,t.target),e.emit("addFriend",p.getUser(t.target))}),e.on("deleteFriend",function(t){p.removeFriend(t.account,t.target),e.emit("deleteFriend",t)}),e.on("addBlacklist",function(t){var n=p.isFriend(t.account,t.target),r=p.addBlacklist(t.account,t.target,n);e.emit("addBlacklist",r),n&&(p.removeFriend(t.account,t.target,!0),e.emit("deleteFriend",t))}),e.on("removeBlacklist",function(t){var n=p.removeBlacklist(t.account,t.target);if(e.emit("removeBlacklist",{account:t.target}),n.friend){p.addFriend(t.account,t.target,n.noteName);var r=p.getUser(t.target);r.noteName=n.noteName,e.emit("addFriend",r)}}),e.on("updateNoteName",function(t){p.updateNoteName(t.owner,t.target,t.noteName),e.emit("updateNoteName",t)}),e.on("updateUserInfo",function(t){var n=p.updateUserInfo(t.account,t.info);e.emit("updateUserInfo",n)}),e.on("updateGroupName",function(t){p.updateGroupName(t.account,t.value),e.emit("updateGroupName",t);var n={type:"systemMsg",to:t.account,content:"你修改了群名称",time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateTeamName",function(t){p.updateTeamName(t.account,t.value),e.emit("updateTeamName",t);var n={type:"systemMsg",to:t.account,content:"你修改了讨论组名称",time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateGroupDes",function(t){p.updateGroupDes(t.account,t.value),e.emit("updateGroupDes",t);var n={type:"systemMsg",to:t.account,content:"你更新群介绍为"+t.value,time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateAuthentication",function(t){p.updateAuthentication(t.account,t.value),e.emit("updateAuthentication",t);var n={type:"systemMsg",to:t.account,content:"群身份验证模式更新为"+(0===t.value?"允许任何人加入":1===t.value?"需要验证消息":"不允许任何人申请加入"),time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateInvitePermissions",function(t){p.updateInvitePermissions(t.account,t.value),e.emit("updateInvitePermissions",t);var n={type:"systemMsg",to:t.account,content:"邀请他人权限为"+(0===t.value?"管理员":"所有人"),time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateModifyPermissions",function(t){p.updateModifyPermissions(t.account,t.value),e.emit("updateModifyPermissions",t);var n={type:"systemMsg",to:t.account,content:"群资料修改权限为"+(0===t.value?"管理员":"所有人"),time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("updateBeAuthentication",function(t){p.updateBeAuthentication(t.account,t.value),e.emit("updateBeAuthentication",t);var n={type:"systemMsg",to:t.account,content:"被邀请他人权限为"+(0===t.value?"不需要验证":"需要验证"),time:(new Date).getTime()};p.updateMessage(n),e.emit("msg",n)}),e.on("msg",function(t){p.updateMessage(t),e.emit("msg",t)})}();var d={fetch:function(){var e=localStorage.getItem("IM");if(e)return JSON.parse(e)},save:function(e){localStorage.setItem("IM",JSON.stringify(e))},clear:function(){localStorage.clear()}};u(window,"load",function(){f=d.fetch()||f,e.mockServerDataBase=f}),u(window,"unload",function(){d.save(f)}),e.mockServerDataBase=f}(this,utils,io);